name: Zip TWRP

on:
  push:
    branches:
      - TWRP
    tags-ignore:
    - "*-*"
env:
  REPO_URL: https://github.com/Sirherobrine23/Moto-G7-Plus-sh23.git
  REPO_BRANCH: TWRP
  UPLOAD_RELEASE: true
  EVENTO: " ${{ github.event_name }} "
  TZ: America/Sao_Paulo

jobs:
  TWRP:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
#    - name: Checando
#      uses: actions/checkout@master

    - name: Inicializando
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq install zip unzip dos2unix
    - name: Clonando
      run: git clone --depth 1 $REPO_URL -b $REPO_BRANCH zip-sh

    - name: Criando o Arquivo
      run: |
       sudo mkdir files/
       cd zip-sh
       sudo dos2unix META-INF/com/google/android/update-binary
       sudo rm -rf README.md LICENSE *.git*
       sudo chmod 644 */*/*/*/*
       sudo zip "$(TZ=UTC+3 date +"%H-%M-%S").zip" -r * 
       sudo mv *-*.zip ../files/
    
    - name: Gerando o body
      id: tag
      run: |
        echo ::set-env name=RELEASE_TAG::"$(TZ=UTC+3 date +"%d/%m/%Y")-TWRP-Zip_files"
        echo "$(TZ=UTC+3 date +"%H:%M:%S")" >> release.txt
        echo "::set-output name=status::success"
    
    - name: Upload do zip para o Release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN }}
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        body_path: release.txt
        files: files/*
  
jobs:  
  Tag-TWRP:
    runs-on: ubuntu-latest
    steps:
      - name: Tag date
        run: |
          echo ::set-env name=DATAA::"$(TZ=UTC+3 date +"%H-%M-%S-%d/%m/%Y")-TWRP-Tag"
      - uses: actions/checkout@master
      - name: Tag
        uses: mathieudutour/github-tag-action@v4.5
        with:
          github_token: ${{ secrets.TOKEN }}
          release_branches: TWRP
          tag_prefix: ${{ env.DATAA }}